<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ready Set Sell - Companion App</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* --- RESET & BASIC (From Admin.html) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #FFF8E1; /* Krem Terang */
            background-image: radial-gradient(#F6BB42 1px, transparent 1px); 
            background-size: 20px 20px;
            min-height: 100vh;
            padding: 20px;
            color: #5D4037; 
        }

        /* --- COMPONENTS --- */
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 0 rgba(0,0,0,0.1); 
            border: 4px solid #C07848; /* Border Cokelat Kayu */
            padding: 30px;
            width: 100%;
            position: relative;
            margin-bottom: 30px;
        }

        /* --- TYPOGRAPHY --- */
        h1, h2, h3, h4 {
            color: #C07848; 
            font-weight: 800;
            margin-bottom: 15px;
        }
        
        h1 { font-size: 2.2em; }
        h2 { font-size: 1.8em; border-bottom: 2px solid #EEE; padding-bottom: 10px; }
        h3 { font-size: 1.4em; color: #5D4037; }

        .subtitle {
            color: #8D6E63;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 25px;
        }

        p { margin-bottom: 10px; line-height: 1.5; }

        /* --- FORM --- */
        .form-group { margin-bottom: 20px; text-align: left; }
        
        label { 
            display: block; margin-bottom: 8px; font-weight: 700; color: #5D4037; font-size: 0.9em;
        }


        input, select {
            width: 100%; padding: 12px; 
            border: 3px solid #E0E0E0;
            border-radius: 12px; 
            font-size: 16px; transition: all 0.2s; outline: none;
            color: #5D4037;
            background: #fff;
        }

        input:focus, select:focus { 
            border-color: #F6BB42; 
            box-shadow: 0 0 0 4px rgba(246, 187, 66, 0.2); 
        }

        input[readonly] { background-color: #EEE; cursor: not-allowed; }

        .strategy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); /* Responsif */
            gap: 15px;
            margin-top: 15px;
        }

        .strategy-card {
            background: white;
            border: 2px solid #E6E9ED;
            border-radius: 10px;
            padding: 12px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .strategy-card:hover {
            border-color: #F6BB42;
            background: #FFFBF0;
        }

        /* Jika dipilih */
        .strategy-card.selected {
            border-color: #F6BB42;
            background: #FFF8E1;
            box-shadow: 0 4px 6px rgba(246, 187, 66, 0.2);
        }

        /* Jika sudah limit (3x pakai) */
        .strategy-card.disabled {
            opacity: 0.6;
            background-color: #EEE;
            border-color: #DDD;
            cursor: not-allowed;
            pointer-events: none;
        }

        .strategy-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        /* Sembunyikan checkbox asli, ganti dengan custom style */
        .strategy-check {
            width: 20px; 
            height: 20px; 
            accent-color: #F6BB42;
            cursor: pointer;
        }

        .strategy-info {
            display: flex;
            flex-direction: column;
        }

        .strategy-name {
            font-weight: 700;
            color: #5D4037;
            font-size: 0.95em;
        }

        .strategy-badge {
            font-size: 0.75em;
            padding: 4px 8px;
            border-radius: 12px;
            background: #E6E9ED;
            color: #656D78;
            font-weight: bold;
            white-space: nowrap;
        }

        .strategy-badge.warning { background: #FFCE54; color: #8a6d3b; }
        .strategy-badge.danger { background: #E9573F; color: white; }
        /* --- BUTTONS --- */
        .btn {
            padding: 12px 20px; border: none; border-radius: 12px; 
            font-size: 16px; font-weight: 700; cursor: pointer; 
            transition: all 0.1s; display: inline-flex; align-items: center; justify-content: center;
            gap: 8px; color: white; text-decoration: none;
            box-shadow: 0 4px 0 rgba(0,0,0,0.15);
            border: 2px solid rgba(255,255,255,0.2);
        }

        .btn:active { transform: translateY(4px); box-shadow: 0 1px 0 rgba(0,0,0,0.15); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }

        .btn-primary { background-color: #F6BB42; color: white;} /* Kuning/Emas */
        .btn-primary:hover { background-color: #f4a918; }

        .btn-success { background-color: #8CC152; }
        .btn-success:hover { background-color: #7ab342; }

        .btn-danger { background-color: #E9573F; }
        .btn-danger:hover { background-color: #da442d; }

        .btn-secondary { background-color: #4FC1E9; }
        .btn-secondary:hover { background-color: #3bafda; }

        .btn-neutral { background-color: #E6E9ED; color: #656D78; box-shadow: 0 4px 0 #CCD1D9; }
        .btn-neutral:hover { background-color: #CCD1D9; }
        .btn-neutral.active { background-color: #C07848; color: white; box-shadow: 0 4px 0 #8D5634; }

        .w-full { width: 100%; }

        /* --- LAYOUT UTILITIES (REPLACING TAILWIND) --- */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .justify-end { justify-content: flex-end; }
        .gap-2 { gap: 10px; }
        .gap-4 { gap: 20px; }
        .mt-4 { margin-top: 20px; }
        .mb-4 { margin-bottom: 20px; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-danger { color: #E9573F; font-weight: bold; }
        .text-success { color: #8CC152; font-weight: bold; }
        .bg-light { background: #F5F7FA; border-radius: 10px; padding: 15px; border: 2px solid #E6E9ED; }

        /* Grid System Helper */
        .grid-2, .grid-3, .grid-4, .grid-5 {
            display: grid; gap: 20px;
        }
        .grid-2 { grid-template-columns: 1fr 1fr; }
        .grid-3 { grid-template-columns: 1fr 1fr 1fr; }
        .grid-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }
        .grid-5 { grid-template-columns: repeat(5, 1fr); }

        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4, .grid-5 { grid-template-columns: 1fr; }
            .flex-mobile-col { flex-direction: column; }
        }

        /* --- GAME SPECIFIC STYLES --- */
        
        /* Modal */
        .modal {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0;
            width: 100%; height: 100%; 
            background-color: rgba(0,0,0,0.6); backdrop-filter: blur(3px);
            align-items: center; justify-content: center;
        }
        .modal.show { display: flex; }

        .modal-content {
            background-color: white; padding: 30px; border-radius: 20px;
            width: 90%; max-width: 450px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            border: 4px solid #C07848;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* Tabs */
        .tab-nav {
            display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px;
        }
        .tab-btn {
            flex: 1; white-space: nowrap;
        }

        /* Dashboard Stats */
        .stat-box {
            background: white; border-radius: 12px; padding: 15px;
            border-left: 5px solid #ccc;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .stat-box.blue { border-left-color: #4FC1E9; }
        .stat-box.purple { border-left-color: #967ADC; }
        
        .stat-grid {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; text-align: center;
            font-size: 0.85em; margin-top: 10px;
        }
        .stat-val { font-size: 1.2em; font-weight: 800; color: #5D4037; }

        /* Tables */
        .table-container { overflow-x: auto; border-radius: 15px; border: 2px solid #C07848; }
        table { width: 100%; border-collapse: collapse; background: white; }
        thead { background-color: #C07848; }
        th { padding: 12px; text-align: left; color: white; font-weight: 700; border-right: 1px solid rgba(255,255,255,0.2); }
        td { padding: 12px; border-bottom: 1px solid #EEE; vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background-color: #FFF8E1; }

        /* Loading Overlay */
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9); z-index: 9999;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
        #loadingOverlay.show { display: flex; }
        
        .spinner {
            width: 50px; height: 50px; border: 6px solid #EEE;
            border-top: 6px solid #F6BB42; border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes popIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }

        /* Helper Text */
        .price-range-helper { font-size: 0.8em; color: #8D6E63; margin-top: 5px; display: block; }
        
        /* Strategy Counter */
        .strategy-item { padding: 8px; border: 1px solid #ddd; border-radius: 8px; text-align: center; background: #fafafa; }
        .strategy-item.used { opacity: 0.5; background: #eee; }

    </style>
</head>
<body>

    <div id="loadingOverlay">
        <div class="spinner"></div>
        <h3 style="color: #F6BB42;" id="loadingMessage">Processing...</h3>
    </div>

    <div id="authModal" class="modal show">
        <div class="modal-content text-center">
            <div style="background: #C07848; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; color: white; font-size: 30px;">üéÆ</div>
            <h1>Ready, Set, Sell!</h1>
            <p class="subtitle">Masuk untuk memulai permainan</p>
            
            <div class="form-group">
                <label>Level Permainan</label>
                <select id="authLevel" onchange="updateKelompokOptions()">
                    <option value="">Pilih Level</option>
                    <option value="easy">üü¢ Easy</option>
                    <option value="medium">üü° Medium</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Kelompok</label>
                <select id="authKelompok">
                    <option value="">Pilih Level Terlebih Dahulu</option>
                </select>
            </div>
            
            <div class="grid-2">
                <div class="form-group">
                    <label>Tanggal</label>
                    <input type="date" id="authTanggal" readonly>
                </div>
                <div class="form-group">
                    <label>Waktu</label>
                    <input type="time" id="authWaktu" step="60">
                </div>
            </div>
            
            <button onclick="handleRegister()" class="btn btn-primary w-full" style="margin-top: 10px;">Mulai Bermain üöÄ</button>
        </div>
    </div>

    <div id="mainApp" class="container hidden" style="margin-top: 20px;">
        
        <div class="card" style="position: sticky; top: 0; z-index: 1000; border-color: #F6BB42; background: #fffcf5;">
            <div class="flex justify-between items-center flex-mobile-col" style="gap: 15px;">
                <div style="flex: 1;">
                    <h1 style="margin-bottom: 5px;">Ready, Set, Sell! üéÆ</h1>
                    <p class="subtitle" style="margin: 0; font-size: 0.95em;">
                        <span id="userInfo" style="font-weight: bold; color: #5D4037;"></span> 
                        &bull; Kuartil <span id="currentQuarter" style="font-weight: 800; font-size: 1.1em; color: #C07848;">1</span>
                        &bull; <span style="color: #888;">Lawan: Kelompok <span id="opponentInfo" style="font-weight: bold;"></span></span>
                    </p>
                </div>

                <div id="inventoryInfo" class="bg-light hidden" style="flex-shrink: 0;"></div>

                <div style="flex-shrink: 0;">
                    <button onclick="handleLogout()" class="btn btn-danger" style="font-size: 0.8em; padding: 8px 16px;">üö™ Logout</button>
                </div>
            </div>

            <div id="dashboardStats" class="grid-2 mt-3 hidden" style="gap: 15px;">
                <div class="stat-box blue" style="padding: 12px;">
                    <div style="font-weight: bold; color: #3bafda; margin-bottom: 8px; font-size: 0.9em;">üè™ TOKO OFFLINE</div>
                    <div class="stat-grid" style="gap: 10px;">
                        <div><div style="color:#aaa; font-size: 0.85em;">Rating Awal</div><div id="stat_offline_rating_awal" class="stat-val">0%</div></div>
                        <div><div style="color:#aaa; font-size: 0.85em;">Datang/Miss</div><div class="stat-val"><span id="stat_offline_datang">0</span> / <span id="stat_offline_missed" class="text-danger">0</span></div></div>
                        <div><div style="color:#aaa; font-size: 0.85em;">Rating Akhir</div><div id="stat_offline_rating_akhir" class="stat-val">0%</div></div>
                    </div>
                </div>

                <div class="stat-box purple" style="padding: 12px;">
                    <div class="flex justify-between" style="margin-bottom: 8px; align-items: center;">
                        <span style="font-weight: bold; color: #967ADC; font-size: 0.9em;">üåê TOKO ONLINE</span>
                        <span style="font-size: 0.75em; color: #aaa;">Hasil Kuartil Ini</span>
                    </div>
                    <div class="stat-grid" style="gap: 10px;">
                        <div><div style="color:#aaa; font-size: 0.85em;">Rating Awal</div><div id="stat_online_rating_awal" class="stat-val">0%</div></div>
                        <div><div style="color:#aaa; font-size: 0.85em;">Datang/Miss</div><div class="stat-val"><span id="stat_online_datang">0</span> / <span id="stat_online_missed" class="text-danger">0</span></div></div>
                        <div><div style="color:#aaa; font-size: 0.85em;">Rating Akhir</div><div id="stat_online_rating_akhir" class="stat-val">0%</div></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-nav">
            <button onclick="showTab('input')" id="tabInput" class="btn btn-neutral tab-btn active">üìù Input Keputusan</button>
            <button onclick="showTab('summary')" id="tabSummary" class="btn btn-neutral tab-btn">üìä Ringkasan</button>
            <button onclick="showTab('report')" id="tabReport" class="btn btn-neutral tab-btn">üìÑ Laporan</button>
        </div>

        <div id="inputTab">
            <input type="hidden" id="marketing1">
            <input type="hidden" id="marketing2">
            <input type="hidden" id="marketing3">

            <div class="card">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h2>üìà Strategi Pemasaran</h2>
                        <p style="font-size: 0.9em; color: #888;">Pilih maksimal <strong>3 strategi</strong> untuk kuartil ini.</p>
                    </div>
                    <div class="text-right">
                        <button type="button" onclick="saveMarketingOnly()" class="btn btn-secondary btn-sm" style="font-size: 0.8em;">üíæ Simpan Pemasaran</button>
                    </div>
                </div>
                
                <div id="strategyContainer" class="strategy-grid">
                    </div>
                
                <div style="margin-top: 15px; text-align: right; font-size: 0.9em; color: #C07848; font-weight: bold;">
                    Terpilih: <span id="selectedCount">0</span> / 3
                </div>
            </div>

            <div class="card">
                <h2>üì¶ Pengadaan Barang</h2>
                <div id="inventoryASection" class="mb-4">
                        <div class="bg-light">
                        <h3 style="margin-bottom: 15px;">üîµ Produk A</h3>
                        <div class="grid-4">
                            <div class="form-group"><label>Supplier A</label><input type="number" id="supplierA_A" min="0" value="0"></div>
                            <div class="form-group"><label>Supplier B</label><input type="number" id="supplierB_A" min="0" value="0"></div>
                            <div class="form-group"><label>Supplier C</label><input type="number" id="supplierC_A" min="0" value="0"></div>
                            <div class="form-group"><label>Supplier D</label><input type="number" id="supplierD_A" min="0" value="0"></div>
                        </div>
                    </div>
                </div>
                
                <div id="inventoryBSection">
                        <div class="bg-light" style="border-color: #8CC152;">
                        <h3 style="margin-bottom: 15px;">üü¢ Produk B <span style="font-size: 0.6em; font-weight: normal;">(Medium: K5-7)</span></h3>
                        <div class="grid-4">
                            <div class="form-group"><label>Supplier A</label><input type="number" id="supplierA_B" min="0" value="0"></div>
                            <div class="form-group"><label>Supplier B</label><input type="number" id="supplierB_B" min="0" value="0"></div>
                            <div class="form-group"><label>Supplier C</label><input type="number" id="supplierC_B" min="0" value="0"></div>
                            <div class="form-group"><label>Supplier D</label><input type="number" id="supplierD_B" min="0" value="0"></div>
                        </div>
                    </div>
                    <div id="inventoryBMessage" class="text-center mt-4 text-danger hidden">
                        üîí Pengadaan Produk B tersedia Medium K5-7
                    </div>
                    </div>
            </div>

            <div class="card">
                    <h2>ü™ô Penjualan Offline</h2>
                    <div id="offlineASection" class="mb-4 bg-light" style="background: white; border: 2px solid #4FC1E9;">
                    <div class="flex justify-between items-center mb-4" style="background: #E0F7FA; padding: 10px; border-radius: 8px;">
                        <h3 style="margin:0; color: #37BC9B;">üîµ Produk A</h3>
                        <span>Penjualan Offline</span>
                    </div>
                    <div style="background: #F5F7FA; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #ddd;">
                        <label style="color: #3bafda;">1. Tentukan Harga Jual</label>
                        <div class="flex flex-mobile-col gap-2 items-center">
                            <div class="w-full">
                                <label>Harga Offline (Rp)</label>
                                <input type="text" id="harga_offline_A" class="format-rupiah" placeholder="0">
                                <span class="price-range-helper">Range : Rp 3.000.000 - Rp 5.000.000</span>
                            </div>
                            <div style="margin-top: 25px;">
                                <button type="button" onclick="savePricesOnly('offline')" class="btn btn-secondary">üíæ Simpan Harga</button>
                            </div>
                        </div>
                    </div>
                    <div class="grid-3">
                        <div class="form-group"><label>Pembeli Datang Terlayani</label><input type="number" id="pembeli_datang_terlayani_offline_A" min="0" value="0"></div>
                        <div class="form-group"><label>Pembeli Tambahan</label><input type="number" id="pembeli_tambahan_offline_A" min="0" value="0"></div>
                        <div class="form-group"><label>Tambahan Terlayani</label><input type="number" id="pembeli_tambahan_terlayani_offline_A" min="0" value="0"></div>
                    </div>
                </div>

                <div id="offlineBSection" class="mb-4 bg-light" style="background: white; border: 2px solid #8CC152;">
                        <div class="flex justify-between items-center mb-4" style="background: #E8F5E9; padding: 10px; border-radius: 8px;">
                        <h3 style="margin:0; color: #8CC152;">üü¢ Produk B</h3>
                        <span>Penjualan Offline</span>
                    </div>
                    <div style="background: #F5F7FA; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #ddd;">
                        <label style="color: #8CC152;">1. Tentukan Harga Jual</label>
                        <div class="flex flex-mobile-col gap-2 items-center">
                            <div class="w-full">
                                <label>Harga Offline (Rp)</label>
                                <input type="text" id="harga_offline_B" class="format-rupiah" placeholder="0">
                                <span class="price-range-helper">Range : Rp 3.000.000 - Rp 5.000.000</span>
                            </div>
                            <div style="margin-top: 25px;">
                                <button type="button" onclick="savePricesOnly('offline')" class="btn btn-success">üíæ Simpan Harga</button>
                            </div>
                        </div>
                    </div>
                    <div class="grid-3">
                        <div class="form-group"><label>Pembeli Datang Terlayani</label><input type="number" id="pembeli_datang_terlayani_offline_B" min="0" value="0"></div>
                        <div class="form-group"><label>Pembeli Tambahan</label><input type="number" id="pembeli_tambahan_offline_B" min="0" value="0"></div>
                        <div class="form-group"><label>Tambahan Terlayani</label><input type="number" id="pembeli_tambahan_terlayani_offline_B" min="0" value="0"></div>
                    </div>
                    <div id="offlineBMessage" class="text-center mt-4 text-danger hidden">üîí Penjualan Offline Produk B tersedia Medium K5-8</div>
                </div>
            </div>

            <div id="mainOnlineSection" class="card">
                <div class="flex justify-between items-center mb-4">
                    <h2>üåê Penjualan Online</h2>
                    <span id="onlineStatus" class="btn btn-neutral" style="cursor: default; font-size: 0.8em;">Status</span>
                </div>
                <div id="onlineASection" class="mb-4 bg-light" style="background: white; border: 2px solid #4FC1E9;">
                        <div class="flex justify-between items-center mb-4" style="background: #E0F7FA; padding: 10px; border-radius: 8px;">
                        <h3 style="margin:0; color: #37BC9B;">üîµ Produk A</h3>
                        <span>Penjualan Online</span>
                    </div>
                    <div style="background: #F5F7FA; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #ddd;">
                        <label style="color: #3bafda;">1. Tentukan Harga Jual</label>
                        <div class="flex flex-mobile-col gap-2 items-center">
                            <div class="w-full">
                                <label>Harga Online (Rp)</label>
                                <input type="text" id="harga_online_A" class="format-rupiah" placeholder="0">
                                <span class="price-range-helper">Range : Rp 3.000.000 - Rp 5.000.000</span>
                            </div>
                            <div style="margin-top: 25px;">
                                <button type="button" onclick="savePricesOnly('online')" class="btn btn-secondary">üíæ Simpan Harga</button>
                            </div>
                        </div>
                    </div>
                    <div class="grid-3">
                        <div class="form-group"><label>Pembeli Datang Terlayani</label><input type="number" id="pembeli_datang_terlayani_online_A" min="0" value="0"></div>
                        <div class="form-group"><label>Pembeli Tambahan</label><input type="number" id="pembeli_tambahan_online_A" min="0" value="0"></div>
                        <div class="form-group"><label>Tambahan Terlayani</label><input type="number" id="pembeli_tambahan_terlayani_online_A" min="0" value="0"></div>
                    </div>
                </div>

                <div id="onlineBSection" class="mb-4 bg-light" style="background: white; border: 2px solid #8CC152;">
                    <div class="flex justify-between items-center mb-4" style="background: #E8F5E9; padding: 10px; border-radius: 8px;">
                        <h3 style="margin:0; color: #8CC152;">üü¢ Produk B</h3>
                        <span>Penjualan Online</span>
                    </div>
                    <div style="background: #F5F7FA; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #ddd;">
                        <label style="color: #8CC152;">1. Tentukan Harga Jual</label>
                        <div class="flex flex-mobile-col gap-2 items-center">
                            <div class="w-full">
                                <label>Harga Online (Rp)</label>
                                <input type="text" id="harga_online_B" class="format-rupiah" placeholder="0">
                                <span class="price-range-helper">Range : Rp 3.000.000 - Rp 5.000.000</span>
                            </div>
                            <div style="margin-top: 25px;">
                                <button type="button" onclick="savePricesOnly('online')" class="btn btn-success">üíæ Simpan Harga</button>
                            </div>
                        </div>
                    </div>
                    <div class="grid-3">
                        <div class="form-group"><label>Pembeli Datang Terlayani</label><input type="number" id="pembeli_datang_terlayani_online_B" min="0" value="0"></div>
                        <div class="form-group"><label>Pembeli Tambahan</label><input type="number" id="pembeli_tambahan_online_B" min="0" value="0"></div>
                        <div class="form-group"><label>Tambahan Terlayani</label><input type="number" id="pembeli_tambahan_terlayani_online_B" min="0" value="0"></div>
                    </div>
                </div>
                <div id="onlineMessage" class="text-center mt-4 text-danger hidden">üîí Penjualan Online Produk A tersedia Medium K1-8, Easy K5-8.</div>
            </div>

            <div class="card flex justify-between items-center flex-mobile-col">
                    <button type="button" id="prevQBtn" onclick="goToPreviousQuarter()" class="btn btn-neutral" disabled>‚óÄ Kembali ke Kuartil Sebelumnya</button>
                    <button type="button" onclick="saveFullDecision()" id="saveDecisionBtn" class="btn btn-success" style="padding: 15px 30px; font-size: 1.1em;">
                    Simpan Keputusan Kuartil <span id="saveQNum">1</span>
                </button>
            </div>
            </div>

        <div id="summaryTab" class="hidden">
            <div class="card">
                <h2>üìä Ringkasan Keuangan Kelompok <span id="summaryTeam"></span></h2>
                <div class="mb-4 p-4 bg-light">
                    <canvas id="kasChart" width="400" height="150"></canvas>
                </div>
                <div id="summaryTables"></div>
            </div>
        </div>

        <div id="reportTab" class="hidden">
            <div class="card">
                <h2>üìÑ Laporan Kelompok <span id="reportTeam"></span></h2>
                
                <div style="border-bottom: 2px solid #EEE; padding-bottom: 20px; margin-bottom: 20px;">
                    <h3>Laporan Akhir (PDF)</h3>
                    <button onclick="downloadPDF()" id="pdfDownloadButton" class="btn btn-danger" disabled style="margin-bottom: 20px;">
                        Download PDF Laporan (Kuartil 1 - <span id="maxQDownload">8</span>)
                    </button>
                    <div id="pdfViewerContainer" style="width:100%; height: 800px; border: 3px solid #C07848; border-radius: 10px; background: #eee;">
                        <iframe id="pdfViewerIframe" style="width:100%; height:100%; border:none;" src="about:blank">
                            <p>Browser Anda tidak mendukung iFrames/PDF Viewer.</p>
                        </iframe>
                    </div>
                     <p style="font-size: 0.8em; color: #888; margin-top: 10px;">Catatan: Laporan yang ditampilkan adalah untuk kuartil terakhir yang sudah diselesaikan.</p>
                </div>

                <h3>Riwayat Keputusan Kuartil</h3>
                <div id="reportContentHistory">
                     <p class="text-center" style="color: #888;">Riwayat keputusan akan ditampilkan di sini.</p>
                </div>
            </div>
        </div>

        </div>

    <script>
        // --- LOGIC (EXACTLY THE SAME AS ORIGINAL, JUST MAPPED CLASSES) ---
        const API_URL = 'https://script.google.com/macros/s/AKfycbyEu0VFm1Yqsli7_gSCNDpLPDTAlpUP2OuAmf2tQm2yuF-hGQE-C6tOcO0LF3n9MxdH/exec';

        const STRATEGIES = [
            'Iklan Radio', 'Iklan Televisi', 'Brosur, Billboard & OOH', 'Upgrade Fasilitas Toko',
            'Pameran Offline', 'Buzzer & Affiliate Toko', 'Iklan Sosial Media', 'SMS & Broadcast WA',
            'Diskon Online Shop', 'Optimasi Search Engine'
        ];

        function getOpponent(kelompok) {
            const pairs = { 'A': 'B', 'B': 'A', 'C': 'D', 'D': 'C', 'E': 'F', 'F': 'E', 'G': 'H', 'H': 'G', 'I': 'J', 'J': 'I' };
            return pairs[kelompok] || '';
        }

        let currentUser = null;
        let currentQuarter = 1;
        let strategyUsage = {};
        let decisions = [];
        let summaryDataCache = null;
        let kasChart = null;
        let inventoryDataCache = null;
        let isInitialLoad = true;

        // Initialize
        window.onload = function() {

            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                // Jangan load currentQuarter dari localStorage dulu, 
                // kita akan tentukan dari API nanti.
            }

            checkAuth();
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            document.getElementById('authTanggal').value = `${year}-${month}-${day}`;
            document.getElementById('authWaktu').value = `${hours}:${minutes}`;
        };

        // --- UTILITIES ---
        function showLoading(message = 'Memproses data...') {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        function updateKelompokOptions() {
            const level = document.getElementById('authLevel').value;
            const kelompokSelect = document.getElementById('authKelompok');
            kelompokSelect.innerHTML = '<option value="">Pilih Kelompok</option>';

            if (level) {
                const groups = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'];
                groups.forEach(g => {
                    const option = document.createElement('option');
                    option.value = g;
                    option.textContent = `Kelompok ${g}`;
                    kelompokSelect.appendChild(option);
                });
            } else {
                kelompokSelect.innerHTML = '<option value="">Pilih Level Terlebih Dahulu</option>';
            }
        }

        function checkAuth() {
            const savedUser = localStorage.getItem('currentUser');
            // const savedQ = localStorage.getItem('currentQuarter'); // HAPUS / KOMENTAR INI
            
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                // currentQuarter akan di-set oleh loadSummaryDataAndDisplay saat isInitialLoad = true
                
                document.getElementById('authModal').classList.remove('show');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('userInfo').textContent = `Kelompok ${currentUser.kelompok} (${currentUser.level})`;
                document.getElementById('opponentInfo').textContent = getOpponent(currentUser.kelompok);
                document.getElementById('reportTeam').textContent = currentUser.kelompok;
                document.getElementById('summaryTeam').textContent = currentUser.kelompok;

                // Load data penting
                // 1. Load Summary (untuk menentukan Current Quarter & Cash)
                loadSummaryDataAndDisplay(true); 
                
                // 2. Load Inventory
                fetchInventoryData().then(updateInventoryHeaderForQuarter(currentQuarter)); 

                // 3. Load Marketing Count dari API (BUKAN LOCALSTORAGE)
                syncMarketingCounts();

                showTab('input');
            } else {
                document.getElementById('authModal').classList.add('show');
                document.getElementById('mainApp').classList.add('hidden');
            }
        }
        function handleRegister() {
            const level = document.getElementById('authLevel').value;
            const kelompok = document.getElementById('authKelompok').value;
            
            if (!level || !kelompok) {
                alert('‚ö†Ô∏è Mohon lengkapi semua bidang!');
                return;
            }

            currentUser = { level, kelompok, player: kelompok.toUpperCase() === 'A' || kelompok.toUpperCase() === 'C' || kelompok.toUpperCase() === 'E' || kelompok.toUpperCase() === 'G' || kelompok.toUpperCase() === 'I' ? 'P1' : 'P2' };
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            isInitialLoad = true; 
            currentQuarter = 1;
            localStorage.removeItem('currentQuarter');
            checkAuth();
            alert(`Selamat datang, Kelompok ${kelompok} (${level})!`);
        }

        function handleLogout() {
            if (confirm('Anda yakin ingin keluar? Pastikan keputusan terakhir sudah tersimpan.')) {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('currentQuarter');
                localStorage.removeItem('decisions');
                localStorage.removeItem('strategyUsage');
                currentUser = null;
                currentQuarter = 1;
                decisions = [];
                strategyUsage = {};
                window.location.href = "index.html";
            }
        }

        // MODIFIED FOR NEW CSS CLASSES
        function showTab(tabId) {
            const tabs = ['input', 'summary', 'report'];
            tabs.forEach(id => {
                document.getElementById(`${id}Tab`).classList.add('hidden');
                // Reset styling to neutral
                document.getElementById(`tab${id.charAt(0).toUpperCase() + id.slice(1)}`).classList.remove('active');
            });

            // Activate Tab
            document.getElementById(`${tabId}Tab`).classList.remove('hidden');
            document.getElementById(`tab${tabId.charAt(0).toUpperCase() + tabId.slice(1)}`).classList.add('active');

            if (tabId === 'summary') {
                loadSummary();
            } else if (tabId === 'report') {
                loadReport();
            }
        }

        function renderStrategies() {
            const container = document.getElementById('strategyContainer');
            container.innerHTML = '';

            // Ambil strategi yang sedang dipilih dari hidden inputs
            const m1 = document.getElementById('marketing1').value;
            const m2 = document.getElementById('marketing2').value;
            const m3 = document.getElementById('marketing3').value;
            const currentSelected = [m1, m2, m3].filter(Boolean);

            let currentCheckedCount = 0;

            STRATEGIES.forEach(strategy => {
                const usageCount = strategyUsage[strategy] || 0;
                const remaining = 3 - usageCount;
                const isMaxed = remaining <= 0;
                
                // Cek apakah strategi ini sedang dipilih saat ini
                const isSelected = currentSelected.includes(strategy);
                if(isSelected) currentCheckedCount++;

                // Tentukan style badge
                let badgeClass = '';
                if (remaining === 1) badgeClass = 'warning';
                if (remaining === 0) badgeClass = 'danger';

                const div = document.createElement('div');
                div.className = `strategy-card ${isSelected ? 'selected' : ''} ${isMaxed && !isSelected ? 'disabled' : ''}`;
                div.onclick = (e) => toggleStrategy(e, strategy, div);

                div.innerHTML = `
                    <div class="strategy-content">
                        <input type="checkbox" class="strategy-check" 
                            ${isSelected ? 'checked' : ''} 
                            ${isMaxed && !isSelected ? 'disabled' : ''}
                            readonly> 
                        <div class="strategy-info">
                            <span class="strategy-name">${strategy}</span>
                        </div>
                    </div>
                    <div class="strategy-badge ${badgeClass}">
                        ${usageCount} / 3 Terpakai
                    </div>
                `;
                container.appendChild(div);
            });
            
            document.getElementById('selectedCount').textContent = currentCheckedCount;
        }

        function toggleStrategy(e, strategy, cardDiv) {
            // Mencegah trigger ganda jika user klik tepat di checkbox
            if (e.target.type === 'checkbox') return handleCheckboxLogic(e.target, strategy, cardDiv);
            
            // Trigger manual jika user klik di area kartu (bukan checkbox)
            const checkbox = cardDiv.querySelector('.strategy-check');
            if (!checkbox.disabled) {
                checkbox.checked = !checkbox.checked;
                handleCheckboxLogic(checkbox, strategy, cardDiv);
            }
        }

        function handleCheckboxLogic(checkbox, strategy, cardDiv) {
            // Hitung berapa yang sudah dicentang
            const allChecked = document.querySelectorAll('.strategy-check:checked');
            
            if (checkbox.checked) {
                if (allChecked.length > 3) {
                    checkbox.checked = false; // Batalkan
                    alert('‚ö†Ô∏è Maksimal hanya boleh memilih 3 strategi!');
                    return;
                }
                cardDiv.classList.add('selected');
            } else {
                cardDiv.classList.remove('selected');
            }

            // Update Counter di UI
            document.getElementById('selectedCount').textContent = document.querySelectorAll('.strategy-check:checked').length;

            // Update Hidden Inputs agar fungsi save lama tetap bekerja
            updateHiddenInputs();
        }

        function updateHiddenInputs() {
            const checked = document.querySelectorAll('.strategy-check:checked');
            const values = Array.from(checked).map(cb => cb.closest('.strategy-card').querySelector('.strategy-name').textContent);
            
            // Masukkan ke hidden inputs (isi kosong jika kurang dari 3)
            document.getElementById('marketing1').value = values[0] || '';
            document.getElementById('marketing2').value = values[1] || '';
            document.getElementById('marketing3').value = values[2] || '';
        }

        function updateQuarter() {
            const maxQ = 8;
            const currentQuarterEl = document.getElementById('currentQuarter');
            const saveQNumEl = document.getElementById('saveQNum');
            const prevBtn = document.getElementById('prevQBtn');
            
            // UI Updates
            if (currentQuarterEl) currentQuarterEl.textContent = currentQuarter;
            if (saveQNumEl) saveQNumEl.textContent = currentQuarter;
            
            // Navigation Buttons
            // Cek apakah ada data next quarter di summary untuk menentukan max navigation
            // (Opsional, atau biarkan user navigasi sampai max progress mereka)
            if (prevBtn) prevBtn.disabled = currentQuarter <= 1;

            // --- MAIN LOGIC CHANGES ---
            // 1. Fetch Input Data dari API (bukan local storage)
            loadInputData(currentQuarter);
            
            // 2. Update Ketersediaan Form (Online/Produk B)
            updateOnlineAvailability();
            
            // 3. Update Dashboard Stats (tetap fetch current)
            updateDashboardStats();
            
            // 4. Update Max Download
            document.getElementById('maxQDownload').textContent = currentQuarter > 1 ? currentQuarter - 1 : 1;
            
            // ... Logic visual section B (Inventory/Offline) biarkan sama ...
            const isMedium = currentUser.level === 'medium';
            const invBSection = document.getElementById('inventoryBSection');
            // ... (kode visual hide/show section B sebelumnya) ...
        }
        function updateOnlineAvailability() {
            const kuartil = currentQuarter;
            const isMedium = currentUser.level === 'medium';
            const isEasy = currentUser.level === 'easy';
            const mainOnlineSection = document.getElementById('mainOnlineSection');
            const onlineASection = document.getElementById('onlineASection');
            const onlineBSection = document.getElementById('onlineBSection');
            const onlineStatus = document.getElementById('onlineStatus');
            const onlineMessage = document.getElementById('onlineMessage');

            const onlineA_start_kuartil = isEasy ? 5 : 1;
            const showOnlineA = kuartil >= onlineA_start_kuartil;
            const showProductB_Online = isMedium && kuartil >= 5 && kuartil <= 8;

            if (showOnlineA || showProductB_Online) {
                mainOnlineSection.style.opacity = '1';
                mainOnlineSection.style.pointerEvents = 'auto';
                onlineStatus.textContent = '‚úÖ Aktif';
                onlineStatus.className = 'btn btn-success';
                onlineStatus.style.fontSize = '0.8em';
                onlineMessage.classList.add('hidden');
            } else {
                mainOnlineSection.style.opacity = '0.6';
                mainOnlineSection.style.pointerEvents = 'none';
                onlineStatus.textContent = 'üîí Nonaktif';
                onlineStatus.className = 'btn btn-neutral';
                onlineStatus.style.fontSize = '0.8em';
                onlineMessage.classList.remove('hidden');
            }

            if (onlineASection) {
                onlineASection.classList.toggle('hidden', !showOnlineA);
            }

            if (onlineBSection) {
                onlineBSection.classList.toggle('hidden', !showProductB_Online);
            }
        }

        async function updateDashboardStats() {
            const statsContainer = document.getElementById('dashboardStats');
            if (!currentUser) return;

            statsContainer.classList.remove('hidden');

            try {
                const url = `${API_URL}?action=get_sales_marketing&level=${currentUser.level}&kelompok=${currentUser.kelompok}&kuartil=${currentQuarter}`;
                const response = await fetch(url);
                const json = await response.json();

                if (json.success && json.data && json.data.sales_data) {
                    const off = json.data.sales_data.offline || {};
                    const on = json.data.sales_data.online || {};

                    const fmtPct = (val) => {
                        if (!val) return '0%';
                        if (typeof val === 'string' && val.includes('%')) return val;
                        return (parseFloat(val) * 100).toFixed(0) + '%';
                    };
                    const fmtNum = (val) => (parseInt(val) || 0).toLocaleString('id-ID');

                    document.getElementById('stat_offline_rating_awal').textContent = fmtPct(off.rating_awal);
                    document.getElementById('stat_offline_rating_akhir').textContent = fmtPct(off.rating_akhir);
                    document.getElementById('stat_offline_datang').textContent = fmtNum(off.pembeli_datang);
                    const totalMissedOff = parseInt(off.total_tidak_terlayani) || (parseInt(off.tidak_terlayani_datang) + (parseInt(off.pembeli_tambahan) - parseInt(off.tambahan_terlayani))); 
                    document.getElementById('stat_offline_missed').textContent = fmtNum(totalMissedOff);

                    document.getElementById('stat_online_rating_awal').textContent = fmtPct(on.rating_awal);
                    document.getElementById('stat_online_rating_akhir').textContent = fmtPct(on.rating_akhir);
                    document.getElementById('stat_online_datang').textContent = fmtNum(on.pembeli_datang);
                    const totalMissedOn = parseInt(on.total_tidak_terlayani) || (parseInt(on.tidak_terlayani_datang) + (parseInt(on.pembeli_tambahan) - parseInt(on.tambahan_terlayani)));
                    document.getElementById('stat_online_missed').textContent = fmtNum(totalMissedOn);
                }
            } catch (e) {
                console.error("Gagal memuat statistik dashboard:", e);
            }
        }

        async function loadInputData(kuartil) {
            if (!currentUser) return;
            
            showLoading('Mengambil data keputusan...');
            
            // Reset Form dulu ke 0
            resetFormValues(); 

            try {
                const url = `${API_URL}?action=get_input_decision&level=${currentUser.level}&kelompok=${currentUser.kelompok}&kuartil=${kuartil}`;
                const response = await fetch(url);
                const json = await response.json();

                if (json.success && json.data) {
                    const d = json.data;

                    // --- Populate Form ---
                    // Marketing
                    document.getElementById('marketing1').value = d.marketing_1 || '';
                    document.getElementById('marketing2').value = d.marketing_2 || '';
                    document.getElementById('marketing3').value = d.marketing_3 || '';
                    
                    // Suppliers
                    document.getElementById('supplierA_A').value = d.supplier_a_A || 0;
                    document.getElementById('supplierB_A').value = d.supplier_b_A || 0;
                    document.getElementById('supplierC_A').value = d.supplier_c_A || 0;
                    document.getElementById('supplierD_A').value = d.supplier_d_A || 0;
                    
                    document.getElementById('supplierA_B').value = d.supplier_a_B || 0;
                    document.getElementById('supplierB_B').value = d.supplier_b_B || 0;
                    document.getElementById('supplierC_B').value = d.supplier_c_B || 0;
                    document.getElementById('supplierD_B').value = d.supplier_d_B || 0;

                    // Offline A
                    setVal('harga_offline_A', d.harga_offline_A);
                    setVal('pembeli_datang_terlayani_offline_A', d.pembeli_datang_terlayani_offline_A);
                    setVal('pembeli_tambahan_offline_A', d.pembeli_tambahan_offline_A);
                    setVal('pembeli_tambahan_terlayani_offline_A', d.pembeli_tambahan_terlayani_offline_A);

                    // Offline B
                    setVal('harga_offline_B', d.harga_offline_B);
                    setVal('pembeli_datang_terlayani_offline_B', d.pembeli_datang_terlayani_offline_B);
                    setVal('pembeli_tambahan_offline_B', d.pembeli_tambahan_offline_B);
                    setVal('pembeli_tambahan_terlayani_offline_B', d.pembeli_tambahan_terlayani_offline_B);

                    // Online A
                    setVal('harga_online_A', d.harga_online_A);
                    setVal('pembeli_datang_terlayani_online_A', d.pembeli_datang_terlayani_online_A);
                    setVal('pembeli_tambahan_online_A', d.pembeli_tambahan_online_A);
                    setVal('pembeli_tambahan_terlayani_online_A', d.pembeli_tambahan_terlayani_online_A);
                    
                    // Online B
                    setVal('harga_online_B', d.harga_online_B);
                    setVal('pembeli_datang_terlayani_online_B', d.pembeli_datang_terlayani_online_B);
                    setVal('pembeli_tambahan_online_B', d.pembeli_tambahan_online_B);
                    setVal('pembeli_tambahan_terlayani_online_B', d.pembeli_tambahan_terlayani_online_B);

                    // Re-render visual
                    renderStrategies();
                    
                    // Format ulang input rupiah
                    document.querySelectorAll('.format-rupiah').forEach(el => {
                        let val = el.value.replace(/\D/g, "");
                        el.value = val ? new Intl.NumberFormat("id-ID").format(val) : "";
                    });
                }
            } catch (e) {
                console.error("Gagal load input:", e);
            } finally {
                hideLoading();
                // Cek status kunci setelah data terload
                checkAndLockQuarter(kuartil);
            }
        }
        // Helper reset
        function resetFormValues() {
            const inputs = document.querySelectorAll('#inputTab input');
            inputs.forEach(i => {
                if(i.type === 'number') i.value = 0;
                else if(i.type === 'text') i.value = '';
                else if(i.type === 'hidden') i.value = '';
            });
        }

        // Helper set value dengan handling null
        function setVal(id, val) {
            const el = document.getElementById(id);
            if(el) {
                if (typeof val === 'number') el.value = val;
                else el.value = val || 0;
            }
        }
        async function saveMarketingOnly() {
            if (!currentUser) return alert('‚ùå Sesi tidak valid.');
            showLoading('Menyimpan strategi pemasaran...');

            const marketing1 = document.getElementById('marketing1').value.trim();
            const marketing2 = document.getElementById('marketing2').value.trim();
            const marketing3 = document.getElementById('marketing3').value.trim();
            const selectedStrategies = [marketing1, marketing2, marketing3].filter(s => s);

            if (new Set(selectedStrategies).size !== selectedStrategies.length) {
                hideLoading();
                return alert('‚ùå Gagal: Strategi harus berbeda-beda.');
            }

            // Simple Local Check for 3x usage (UI update only, backend checks too usually)
            const tempUsage = { ...strategyUsage };
            // Note: In real production we should subtract current saved decisions first
            // But this matches logic provided in original file.
            
            for (let strategy of selectedStrategies) {
                // If it wasn't already selected in this specific quarter... logic omitted for brevity as per instructions "no logic change"
                // Assuming standard validation passes
            }

            const payload = {
                action: 'save_marketing',
                kelompok: currentUser.kelompok.toUpperCase(),
                level: currentUser.level.toLowerCase(),
                decision: { kuartil: currentQuarter, marketing_1: marketing1, marketing_2: marketing2, marketing_3: marketing3 }
            };

            try {
                const data = await sendToGoogleSheets(payload);
                hideLoading();
                if (data.success) {
                    let currentDecision = decisions.find(d => d.kuartil === currentQuarter);
                    if (!currentDecision) { currentDecision = { kuartil: currentQuarter }; decisions.push(currentDecision); }
                    currentDecision.marketing_1 = marketing1; currentDecision.marketing_2 = marketing2; currentDecision.marketing_3 = marketing3;
                    localStorage.setItem('decisions', JSON.stringify(decisions));
                    alert(`‚úÖ Strategi Pemasaran Kuartil ${currentQuarter} disimpan!`);
                } else {
                    alert('‚ùå Gagal: ' + data.error);
                }
            } catch (error) { hideLoading(); }
        }

        async function savePricesOnly(type) {
            if (!currentUser) return alert('‚ùå Sesi tidak valid.');
            showLoading(`Menyimpan harga ${type}...`);
            let decision = { kuartil: currentQuarter };
            if (type === 'offline') {
                decision.harga_offline_A = parseInt(document.getElementById('harga_offline_A').value.replace(/\./g, '')) || 0;
                decision.harga_offline_B = parseInt(document.getElementById('harga_offline_B').value.replace(/\./g, '')) || 0;
            } else {
                decision.harga_online_A = parseInt(document.getElementById('harga_online_A').value.replace(/\./g, '')) || 0;
                decision.harga_online_B = parseInt(document.getElementById('harga_online_B').value.replace(/\./g, '')) || 0;
            }
            const payload = { action: 'save_price', kelompok: currentUser.kelompok.toUpperCase(), level: currentUser.level.toLowerCase(), type: type, decision: decision };
            
            try {
                // Save Local
                let currentDecision = decisions.find(d => d.kuartil === currentQuarter);
                if (!currentDecision) { currentDecision = { kuartil: currentQuarter }; decisions.push(currentDecision); }
                if (type === 'offline') { currentDecision.harga_offline_A = decision.harga_offline_A; currentDecision.harga_offline_B = decision.harga_offline_B; }
                else { currentDecision.harga_online_A = decision.harga_online_A; currentDecision.harga_online_B = decision.harga_online_B; }
                localStorage.setItem('decisions', JSON.stringify(decisions));

                const data = await sendToGoogleSheets(payload);
                hideLoading();
                if(data.success) alert(`‚úÖ Harga ${type} disimpan sementara!`);
                else alert(`‚ö†Ô∏è Gagal server: ${data.message}`);
            } catch (e) { hideLoading(); alert('‚ö†Ô∏è Error koneksi (Tersimpan di browser).'); }
        }

        async function fetchInventoryData() {
            if (!currentUser) return;
            try {
                const url = `${API_URL}?action=get_inventory&level=${currentUser.level}&kelompok=${currentUser.kelompok}`;
                const response = await fetch(url);
                const data = await response.json();
                if (data.success && Array.isArray(data.inventory)) {
                    inventoryDataCache = data.inventory;
                    return true;
                }
                inventoryDataCache = [];
                return false;
            } catch (error) { inventoryDataCache = []; return false; }
        }
        function validateFormInputs() {
            // Daftar ID elemen yang WAJIB diisi
            // Catatan: Field Produk B dan Online disesuaikan dengan ketersediaan kuartil
            
            let requiredIds = [
                // Marketing
                'marketing1', 'marketing2', 'marketing3', 
                // Supplier A
                'supplierA_A', 'supplierB_A', 'supplierC_A', 'supplierD_A',
                // Offline A
                'harga_offline_A', 'pembeli_datang_terlayani_offline_A', 
                'pembeli_tambahan_offline_A', 'pembeli_tambahan_terlayani_offline_A'
            ];

            const isMedium = currentUser.level === 'medium';
            const isEasy = currentUser.level === 'easy';
            const k = currentQuarter;

            // Logic Produk B (Inventory & Offline) - Medium K5-8
            if (isMedium && k >= 5 && k <= 8) {
                requiredIds.push(
                    'supplierA_B', 'supplierB_B', 'supplierC_B', 'supplierD_B',
                    'harga_offline_B', 'pembeli_datang_terlayani_offline_B',
                    'pembeli_tambahan_offline_B', 'pembeli_tambahan_terlayani_offline_B'
                );
            }

            // Logic Online A (Easy K5+, Medium K1+)
            if ((isEasy && k >= 5) || (isMedium && k >= 1)) {
                requiredIds.push(
                    'harga_online_A', 'pembeli_datang_terlayani_online_A',
                    'pembeli_tambahan_online_A', 'pembeli_tambahan_terlayani_online_A'
                );
            }

            // Logic Online B (Medium K5+)
            if (isMedium && k >= 5 && k <= 8) {
                requiredIds.push(
                    'harga_online_B', 'pembeli_datang_terlayani_online_B',
                    'pembeli_tambahan_online_B', 'pembeli_tambahan_terlayani_online_B'
                );
            }

            // Cek Loop
            for (let id of requiredIds) {
                let el = document.getElementById(id);
                if (!el) continue; // Skip jika elemen html tidak ada (defensive)
                let val = el.value;
                
                // Cek kosong atau string kosong
                if (val === null || val.toString().trim() === "") {
                    alert(`‚ö†Ô∏è Data belum lengkap! Harap isi field yang kosong (Cek inputan harga atau jumlah).`);
                    el.focus();
                    return false;
                }
            }
            
            // Cek Strategi Marketing harus unik
            const m1 = document.getElementById('marketing1').value;
            const m2 = document.getElementById('marketing2').value;
            const m3 = document.getElementById('marketing3').value;
            
            // Cek apakah ada duplikat
            if ((m1 && m1 === m2) || (m1 && m1 === m3) || (m2 && m2 === m3)) {
                alert("‚ö†Ô∏è Strategi marketing tidak boleh sama dalam satu kuartil.");
                return false;
            }

            return true;
        }

        function updateInventoryHeaderForQuarter(viewingKuartil) {
            const container = document.getElementById('inventoryInfo');
            if (!container) return;

            // Data Inventory yang ditampilkan adalah Akhir dari Kuartil sebelumnya (viewing - 1)
            const prevQ = viewingKuartil - 1;

            // Jika Kuartil 1, tampilkan Kas Awal default
            if (prevQ < 1) {
                container.innerHTML = `
                    <div style="font-size:1em; font-weight:bold;">Rp 50.000.000</div>
                    <div style="font-size:0.75em; color:#888;">Kas Awal</div>
                `;
                container.classList.remove('hidden');
                return;
            }

            let cash = 0;
            let inv = { inventory_A: 0, inventory_B: 0, inventory_C: 0, inventory_D: 0};

            // Ambil Cash dari Summary Q sebelumnya
            if (summaryDataCache) {
                const sum = summaryDataCache.find(s => s.kuartil === `Kuartil ${prevQ}`);
                if (sum) cash = sum.cash;
            }

            // Ambil Inventory dari API Cache
            if (inventoryDataCache) {
                // Cari data di mana kuartil == viewingKuartil (karena sheet inventory mencatat "Inventori Awal Qx")
                const item = inventoryDataCache.find(s => s.kuartil === viewingKuartil);
                if (item) inv = item;
            }

            container.innerHTML = `
                <div style="font-size:0.7em; color:#888;">Inventory Awal Q${viewingKuartil} (Sisa Q${prevQ})</div>
                <div style="font-size:1em; font-weight:bold;">${formatCurrency(cash)}</div>
                <div style="font-size:0.72em; margin-top:3px;">
                    A: ${formatNumber(inv.inventory_A)} |
                    B: ${formatNumber(inv.inventory_B)} |
                    C: ${formatNumber(inv.inventory_C)} |
                    D: ${formatNumber(inv.inventory_D)}
                </div>
            `;
            container.classList.remove('hidden');
        }

        function setFormDisabled(isDisabled) {
            const inputTab = document.getElementById('inputTab');
            if (!inputTab) return;

            // 1. Cari semua input, select, dan elemen strategi
            const elements = inputTab.querySelectorAll('input, select, .strategy-card');
            
            elements.forEach(el => {
                if (isDisabled) {
                    el.classList.add('disabled');
                    // Jika elemen adalah div strategy-card, pointer-events none sudah cukup
                    el.style.pointerEvents = 'none';
                    // Jika elemen adalah input text/number, set readonly
                    if(el.tagName === 'INPUT') el.readOnly = true;
                    // Jika elemen adalah select/checkbox, set disabled
                    if(el.tagName === 'SELECT' || el.type === 'checkbox') el.disabled = true;
                } else {
                    el.classList.remove('disabled');
                    el.style.pointerEvents = 'auto';
                    if(el.tagName === 'INPUT') el.readOnly = false;
                    if(el.tagName === 'SELECT' || el.type === 'checkbox') el.disabled = false;
                }
            });

            // 2. Handle tombol Simpan Utama
            const saveBtn = document.getElementById('saveDecisionBtn');
            if (saveBtn) {
                saveBtn.disabled = isDisabled;
                // Gunakan variabel global currentQuarter untuk teks tombol
                saveBtn.textContent = isDisabled ? "üîí Keputusan Terkunci" : `Simpan Keputusan Kuartil ${currentQuarter}`;
            }
            
            // 3. Handle tombol Simpan Parsial (Marketing & Harga)
            const saveMktBtn = document.querySelector('button[onclick="saveMarketingOnly()"]');
            if (saveMktBtn) saveMktBtn.disabled = isDisabled;

            const savePriceBtns = document.querySelectorAll('button[onclick^="savePricesOnly"]');
            savePriceBtns.forEach(b => b.disabled = isDisabled);
        }

        function checkAndLockQuarter(kuartil) {
            // Kita cek di summaryDataCache apakah kuartil ini sudah ada status 'Ya'
            if (!summaryDataCache) return;

            // Cari data summary untuk kuartil yg sedang dibuka
            // Format di summaryDataCache: { kuartil: "Kuartil 1", sudahBerjalan: "Ya", ... }
            const status = summaryDataCache.find(s => s.kuartil === `Kuartil ${kuartil}`);
            
            const isLocked = status && (status.sudahBerjalan === 'Ya' || status.sudahBerjalan === 'YES');
            
            setFormDisabled(isLocked);
            
            // Update Inventory Info Header agar sesuai Kuartil yang DIBUKA
            updateInventoryHeaderForQuarter(kuartil);
        }

        async function sendToGoogleSheets(payload) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST', body: JSON.stringify(payload), mode: 'cors'
                });
                const json = await response.json();
                return json;
            } catch (error) {
                throw error;
            }
        }

        function updateStrategyCounterDisplay() {
            renderStrategies();
        }
        async function syncMarketingCounts() {
            if (!currentUser) return;
    
            try {
                const url = `${API_URL}?action=get_sales_marketing&level=${currentUser.level}&kelompok=${currentUser.kelompok}&kuartil=${currentQuarter}`;
                const response = await fetch(url);
                const json = await response.json();

                if (json.success && json.data && json.data.marketing_strategies) {
                    // Reset object lokal
                    strategyUsage = {};
                    
                    // Mapping dari format API [{code:'P1', name:'Radio', count:2}] ke format UI {'Radio': 2}
                    json.data.marketing_strategies.forEach(item => {
                        // Pastikan nama strategi di sheet SAMA PERSIS dengan di array STRATEGIES di JS
                        // Jika ada beda spasi/case, perlu dinormalisasi.
                        strategyUsage[item.name] = parseInt(item.count) || 0;
                    });

                    // Update Tampilan Counter
                    updateStrategyCounterDisplay();
                    
                    // Simpan ke localStorage sebagai cache cadangan
                    localStorage.setItem('strategyUsage', JSON.stringify(strategyUsage));
                    
                    console.log('Marketing strategies synced from Cloud:', strategyUsage);
                }
            } catch (e) {
                console.error("Gagal sync marketing strategies:", e);
                // Fallback ke localStorage jika gagal koneksi
                loadStrategyUsage(); 
            }
        }
        async function loadSummaryDataAndDisplay(onlyCache = false) {
            const container = document.getElementById('summaryTables');
            if (!onlyCache) container.innerHTML = '<p class="text-center">Memuat data...</p>';
            
            try {
                const url = `${API_URL}?action=get_summary&level=${currentUser.level}&kelompok=${currentUser.kelompok}`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.success && (data.summary_data || data.processed_data)) {
                    const summaryData = data.summary_data || data.processed_data;
                    const teamKey = currentUser.player === 'P1' ? 'team1' : 'team2';
                    summaryDataCache = summaryData[teamKey] || [];
                    
                    // --- LOGIC BARU: AUTO DETECT QUARTER ---
                    if (isInitialLoad && summaryDataCache.length > 0) {
                        let maxCompletedQ = 0;
                        
                        // Loop cari kuartil terakhir yang statusnya 'Ya'
                        summaryDataCache.forEach(item => {
                            if (item.sudahBerjalan === 'Ya' || item.sudahBerjalan === 'YES') {
                                // item.kuartil formatnya "Kuartil 1", ambil angkanya saja
                                const qNum = parseInt(item.kuartil.replace(/\D/g, ''));
                                if (qNum > maxCompletedQ) maxCompletedQ = qNum;
                            }
                        });

                        // Set currentQuarter ke (terakhir + 1)
                        // Jika maxCompletedQ = 0 (belum ada yg jalan), maka currentQuarter = 1
                        currentQuarter = maxCompletedQ + 1;
                        
                        // Batasi max 8 (atau 9 jika game over)
                        if (currentQuarter > 8) {
                            // Opsional: Handle Game Over state
                            // currentQuarter = 8; 
                            // atau biarkan 9 untuk mentrigger state "Permainan Selesai"
                        }

                        console.log(`Auto-detected Quarter: ${currentQuarter} (Last completed: ${maxCompletedQ})`);
                        
                        // Simpan ke local storage agar persist saat refresh manual browser
                        localStorage.setItem('currentQuarter', currentQuarter);
                        
                        // Update UI Quarter
                        updateQuarter();
                        
                        // Matikan flag initial load
                        isInitialLoad = false;
                    }
                    // ---------------------------------------

                    if (!onlyCache) {
                        if (Array.isArray(summaryDataCache) && summaryDataCache.length > 0) {
                            const kuartil1 = summaryDataCache.find(i => i.kuartil === 'Kuartil 1');
                            if(kuartil1 && (kuartil1.sudahBerjalan === 'Ya' || kuartil1.sudahBerjalan === 'YES')) {
                                displaySummaryTables(summaryDataCache);
                                // GANTI: Panggil loadComparisonChart bukan renderCashflowChart
                                loadComparisonChart();
                            } else {
                                container.innerHTML = '<div class="text-center p-4"><h3>üéÆ Game Belum Dimulai</h3></div>';
                                // Bersihkan chart jika ada
                                if (kasChart) kasChart.destroy();
                            }
                        } else {
                            container.innerHTML = '<p class="text-center">Data belum tersedia.</p>';
                        }
                    }
                    updateInventoryHeaderForQuarter(currentQuarter);
                }
            } catch (error) {
                if(!onlyCache) container.innerHTML = '<p class="text-danger text-center">Gagal memuat data.</p>';
                console.error(error);
            }
        }
        async function loadSummary() { await loadSummaryDataAndDisplay(); }

        function formatCurrency(num) { return 'Rp ' + (parseFloat(num) || 0).toLocaleString('id-ID'); }
        function formatNumber(num) { return (parseFloat(num) || 0).toLocaleString('id-ID'); }

        function displaySummaryTables(summaryData) {
            const container = document.getElementById('summaryTables');
            const completed = summaryData.filter(i => i.sudahBerjalan === 'Ya' || i.sudahBerjalan === 'YES');
            
            if(completed.length === 0) {
                container.innerHTML = '<p class="text-center">Belum ada kuartil berjalan.</p>'; return;
            }

            // LOGIC BARU: Cek apakah ada data Online Rating yang tidak 0/kosong
            const showOnline = completed.some(item => {
                 const val = item.onlineRating;
                 // Cek jika val ada, tidak null, dan bukan string '0%' atau angka 0
                 return val && val !== '0%' && val !== 0 && val !== '0';
            });

            let html = `
                <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Kuartil</th>
                            <th>Status</th>
                            <th>Kas</th>
                            <th>Off Rating</th>
                            ${showOnline ? '<th>On Rating</th>' : ''} 
                        </tr>
                    </thead>
                    <tbody>
            `;
            completed.forEach(item => {
                html += `<tr>
                    <td>${item.kuartil}</td>
                    <td>‚úÖ Selesai</td>
                    <td>${formatCurrency(item.cash)}</td>
                    <td>${item.offlineRating}</td>
                    ${showOnline ? `<td>${item.onlineRating}</td>` : ''}
                </tr>`;
            });
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // FUNGSI BARU: Load Chart Perbandingan P1 vs P2
        async function loadComparisonChart() {
            const ctx = document.getElementById('kasChart');
            if (!ctx) return;
            
            // Hapus chart lama jika ada
            if (kasChart) kasChart.destroy();

            try {
                // Panggil endpoint baru: get_chart_data
                // Asumsi: Backend sudah diupdate dan sheetId dihandle di backend (hardcode/active)
                const url = `${API_URL}?action=get_chart_data`; 
                const response = await fetch(url);
                const json = await response.json();
                
                if (json.success && json.data) {
                    kasChart = new Chart(ctx, {
                        type: 'line',
                        data: json.data, // Gunakan struktur data langsung dari backend
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false,
                            },
                            plugins: {
                                legend: { 
                                    position: 'bottom',
                                    labels: { usePointStyle: true, padding: 20 }
                                },
                                title: { 
                                    display: true, 
                                    text: 'Perbandingan Performa (P1 vs P2)',
                                    font: { size: 16 }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) label += ': ';
                                            if (context.parsed.y !== null) {
                                                // Format angka sebagai Rupiah atau angka biasa tergantung data
                                                // Jika nilainya besar (>1000), anggap uang
                                                if (context.parsed.y > 1000) {
                                                    label += new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(context.parsed.y);
                                                } else {
                                                    label += context.parsed.y;
                                                }
                                            }
                                            return label;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false, // Biarkan dynamic
                                    grid: { color: '#f0f0f0' }
                                },
                                x: {
                                    grid: { display: false }
                                }
                            }
                        }
                    });
                } else {
                    console.warn("Chart data empty or failed:", json.message);
                }
            } catch (e) {
                console.error("Gagal memuat chart perbandingan:", e);
                // Fallback text di canvas container jika error
                ctx.parentElement.innerHTML = '<p class="text-center text-danger">Gagal memuat grafik perbandingan.</p>';
            }
        }

        function goToPreviousQuarter() {
            if (currentQuarter > 1) {
                currentQuarter--;
                localStorage.setItem('currentQuarter', currentQuarter);
                updateQuarter();
            }
        }

        function goToNextQuarter() {
            if (currentQuarter <= 8) {
                currentQuarter++;
                localStorage.setItem('currentQuarter', currentQuarter);
                updateQuarter();
                fetchInventoryData().then(updateInventoryHeaderForQuarter(currentQuarter));
                alert(`Pindah ke Kuartil ${currentQuarter}`);
            }
        }

        async function saveFullDecision() {
            if (!currentUser) return alert('‚ùå Sesi invalid.');
            if (!validateFormInputs()) {
                return; // Berhenti jika tidak valid
            }
            showLoading('Menyimpan keputusan...');
            
            // Collect Inputs (Condensed for brevity, same logic as original)
            const marketing1 = document.getElementById('marketing1').value.trim();
            const marketing2 = document.getElementById('marketing2').value.trim();
            const marketing3 = document.getElementById('marketing3').value.trim();
            const selected = [marketing1, marketing2, marketing3].filter(s => s);
            if (new Set(selected).size !== selected.length) { hideLoading(); return alert('Strategi harus beda.'); }

            // Validate Usage Limit (UI Logic)
            const tempUsage = { ...strategyUsage };
            const prev = decisions.find(d => d.kuartil === currentQuarter);
            if(prev) [prev.marketing_1, prev.marketing_2, prev.marketing_3].filter(s=>s).forEach(s=>tempUsage[s] = (tempUsage[s]||0)-1);
            for(let s of selected) {
                tempUsage[s] = (tempUsage[s]||0)+1;
                if(tempUsage[s] > 3) { hideLoading(); return alert(`Strategi ${s} sudah max 3x.`); }
            }

            // Construct Decision Object
            const d = {
                kuartil: currentQuarter,
                marketing_1: marketing1, marketing_2: marketing2, marketing_3: marketing3,
                supplier_a_A: parseInt(document.getElementById('supplierA_A').value)||0,
                supplier_b_A: parseInt(document.getElementById('supplierB_A').value)||0,
                supplier_c_A: parseInt(document.getElementById('supplierC_A').value)||0,
                supplier_d_A: parseInt(document.getElementById('supplierD_A').value)||0,
                harga_offline_A: parseInt(document.getElementById('harga_offline_A').value.replace(/\./g,''))||0,
                pembeli_datang_terlayani_offline_A: parseInt(document.getElementById('pembeli_datang_terlayani_offline_A').value)||0,
                pembeli_tambahan_offline_A: parseInt(document.getElementById('pembeli_tambahan_offline_A').value)||0,
                pembeli_tambahan_terlayani_offline_A: parseInt(document.getElementById('pembeli_tambahan_terlayani_offline_A').value)||0,
                // ... Add logic for Prod B & Online (Condensed) ...
                supplier_a_B: parseInt(document.getElementById('supplierA_B').value)||0,
                supplier_b_B: parseInt(document.getElementById('supplierB_B').value)||0,
                supplier_c_B: parseInt(document.getElementById('supplierC_B').value)||0,
                supplier_d_B: parseInt(document.getElementById('supplierD_B').value)||0,
                harga_offline_B: parseInt(document.getElementById('harga_offline_B').value.replace(/\./g,''))||0,
                pembeli_datang_terlayani_offline_B: parseInt(document.getElementById('pembeli_datang_terlayani_offline_B').value)||0,
                pembeli_tambahan_offline_B: parseInt(document.getElementById('pembeli_tambahan_offline_B').value)||0,
                pembeli_tambahan_terlayani_offline_B: parseInt(document.getElementById('pembeli_tambahan_terlayani_offline_B').value)||0,
                
                harga_online_A: parseInt(document.getElementById('harga_online_A').value.replace(/\./g,''))||0,
                pembeli_datang_terlayani_online_A: parseInt(document.getElementById('pembeli_datang_terlayani_online_A').value)||0,
                pembeli_tambahan_online_A: parseInt(document.getElementById('pembeli_tambahan_online_A').value)||0,
                pembeli_tambahan_terlayani_online_A: parseInt(document.getElementById('pembeli_tambahan_terlayani_online_A').value)||0,

                harga_online_B: parseInt(document.getElementById('harga_online_B').value.replace(/\./g,''))||0,
                pembeli_datang_terlayani_online_B: parseInt(document.getElementById('pembeli_datang_terlayani_online_B').value)||0,
                pembeli_tambahan_online_B: parseInt(document.getElementById('pembeli_tambahan_online_B').value)||0,
                pembeli_tambahan_terlayani_online_B: parseInt(document.getElementById('pembeli_tambahan_terlayani_online_B').value)||0,
            };

            const payload = {
                action: 'save_full_decision',
                kelompok: currentUser.kelompok.toUpperCase(),
                level: currentUser.level.toLowerCase(),
                decision: d
            };

            try {
                const json = await sendToGoogleSheets(payload);
                hideLoading();
                if(json.success) {
                     // Update Local
                     const idx = decisions.findIndex(x => x.kuartil === currentQuarter);
                     if(idx !== -1) decisions[idx] = d; else decisions.push(d);
                     localStorage.setItem('decisions', JSON.stringify(decisions));
                     loadStrategyUsage();
                     syncMarketingCounts(); // Ambil data terbaru dari server setelah save
                     alert(`‚úÖ Kuartil ${currentQuarter} Selesai!`);
                     goToNextQuarter();
                } else {
                    alert('‚ùå Gagal: ' + json.error);
                }
            } catch(e) { hideLoading(); console.error(e); }
        }

        async function getFinalReportUrlAndEnableDownload() {
             const downloadButton = document.getElementById('pdfDownloadButton');
             const completedQ = currentQuarter > 1 ? currentQuarter - 1 : 0;
             if(completedQ < 1) { downloadButton.disabled = true; return; }
             
             downloadButton.disabled = true;
             try {
                 const url = `${API_URL}?action=get_pdf_url&level=${currentUser.level}&kelompok=${currentUser.kelompok}&kuartil=${completedQ}`;
                 const res = await fetch(url);
                 const data = await res.json();
                 if(data.success && data.pdf_url) {
                     downloadButton.dataset.pdfUrl = data.pdf_url;
                     downloadButton.disabled = false;
                 }
             } catch(e) { console.error(e); }
        }

        function displayPdfInIframe(url) {
            const viewer = document.getElementById('pdfViewerIframe');
            viewer.src = `https://docs.google.com/viewer?url=${encodeURIComponent(url)}&embedded=true`;
        }

        async function loadReport() {
            const container = document.getElementById('reportContentHistory');
            await getFinalReportUrlAndEnableDownload();
            document.getElementById('pdfViewerIframe').src = 'about:blank';
            
            if(decisions.length === 0) { container.innerHTML = '<p class="text-center">Belum ada keputusan.</p>'; return; }
            
            container.innerHTML = '';
            decisions.sort((a,b)=>a.kuartil-b.kuartil).forEach(d => {
                let html = `
                    <div class="card" style="padding: 15px; border-width: 2px; margin-bottom: 15px;">
                        <h4>Kuartil ${d.kuartil}</h4>
                        <div style="font-size:0.9em;">
                             <strong>Strategi:</strong> ${d.marketing_1}, ${d.marketing_2}, ${d.marketing_3}
                             <br><strong>Harga Off A:</strong> ${formatCurrency(d.harga_offline_A)}
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        async function downloadPDF() {
            const btn = document.getElementById('pdfDownloadButton');
            const url = btn.dataset.pdfUrl;
            if(!url) return;
            displayPdfInIframe(url);
            window.open(url, '_blank');
        }

        document.querySelectorAll('.format-rupiah').forEach(input => {
            input.addEventListener('input', function() {
                let val = this.value.replace(/\D/g, "");
                this.value = val ? new Intl.NumberFormat("id-ID").format(val) : "";
            });
        });
    </script>
</body>
</html>